#!/usr/bin/env sh

error() { notify-send "ï„ª ERROR" "$1"; exit 1;}

ping -q -c 1 1.1.1.1 > /dev/null || error "No Internet Connection"

[ -z "$1" ] && notify-send "Give either a pdf file or a DOI as an argument." && exit

if [ -f "$1" ]; then
	# Try to get DOI from pdfinfo or pdftotext output.
	doi=$(pdfinfo "$1" | grep -io "doi:.*") ||
	doi=$(pdftotext "$1" 2>/dev/null - | grep -io "doi:.*" -m 1)
else
	doi="$1"
fi

# Check crossref.org for the bib citation.

outNot="Resource not found."

ref=$(curl -s "http://api.crossref.org/works/$doi/transform/application/x-bibtex" -w "\\n")

echo "$ref"
case "$ref" in
	"$outNot"|"<html>*") error "Reference not found";;
	"*") notify-send "Copied" # && printf "$ref" | xsel -b;;
esac
